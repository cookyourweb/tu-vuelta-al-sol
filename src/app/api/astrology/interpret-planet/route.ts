// =============================================================================
// ü™ê INTERPRET PLANET API ROUTE
// app/api/astrology/interpret-planet/route.ts
// Genera interpretaci√≥n de UN SOLO planeta
// =============================================================================

import { NextRequest, NextResponse } from 'next/server';
import connectToDatabase from '@/lib/db';
import { generatePlanetInterpretation } from '@/services/tripleFusedInterpretationService';
import * as admin from 'firebase-admin';


// =============================================================================
// POST - Generate single planet interpretation
// =============================================================================

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const { userId, planetName, sign, house, degree, chartType = 'natal', year } = body;

    console.log('ü™ê [PLANET] Generating interpretation for:', planetName, 'chartType:', chartType);

    if (!userId || !planetName || !sign || !house) {
      return NextResponse.json(
        { success: false, error: 'Missing required fields: userId, planetName, sign, house' },
        { status: 400 }
      );
    }

    // Para Solar Return, el a√±o es obligatorio
    if (chartType === 'solar-return' && !year) {
      return NextResponse.json(
        { success: false, error: 'Year is required for Solar Return interpretations' },
        { status: 400 }
      );
    }

    const mongoose = await connectToDatabase();
    const db = (mongoose as any).connection?.db ?? (mongoose as any).db;

    // Generate planet interpretation
    const interpretation = await generatePlanetInterpretation(
      planetName,
      sign,
      house,
      degree || 0,
      {} as any, // TODO: Add proper userProfile parameter
      chartType,
      year
    );

    if (!interpretation) {
      throw new Error('Failed to generate planet interpretation');
    }

    console.log('‚úÖ [PLANET] Generated interpretation for:', planetName);

    // Save to MongoDB
    const planetKey = `${planetName}-${sign}-${house}`;

    // Determinar categor√≠a del planeta
    let section = 'planets'; // Por defecto

    // Nodos se guardan en "nodes"
    if (planetName.includes('Nodo')) {
      section = 'nodes';
      console.log('üéØ [PLANET] Detectado NODO - guardando en secci√≥n: nodes');
    }
    // Asteroides se guardan en "asteroids"
    else if (['Quir√≥n', 'Lilith', 'Ceres', 'Pallas', 'Juno', 'Vesta'].includes(planetName)) {
      section = 'asteroids';
      console.log('üéØ [PLANET] Detectado ASTEROIDE - guardando en secci√≥n: asteroids');
    }

    console.log(`üìù [PLANET] Guardando en secci√≥n: ${section}`);
    console.log(`üìù [PLANET] chartType: ${chartType}`);
    console.log(`üìù [PLANET] Key completo: ${section}.${planetKey}`);

    // Guardar con el chartType correcto
    await db.collection('interpretations').updateOne(
      { userId, chartType: chartType },
      {
        $set: {
          [`interpretations.${section}.${planetKey}`]: interpretation,
          updatedAt: new Date(),
        },
      },
      { upsert: true }
    );

    console.log('‚úÖ [PLANET] Saved to MongoDB:', `${section}.${planetKey}`, 'chartType:', chartType);

    return NextResponse.json({
      success: true,
      interpretation,
      planetKey,
      chartType,
      message: `Interpretaci√≥n de ${planetName} ${chartType === 'solar-return' ? `SR ${year}` : ''} generada correctamente`,
    });

  } catch (error) {
    console.error('‚ùå [PLANET] Error:', error);
    return NextResponse.json({
      success: false,
      error: error instanceof Error ? error.message : 'Server error',
    }, { status: 500 });
  }
}