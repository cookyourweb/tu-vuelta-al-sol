//src/app/(dashboard)/agenda/page.tsx - NUEVO UX DISRUPTIVO
'use client';

import React, { useState, useEffect } from 'react';
import { format, addMonths, subMonths, isSameMonth, isSameDay, startOfMonth, endOfMonth, eachDayOfInterval } from 'date-fns';
import { es } from 'date-fns/locale';
import { useAuth } from '@/context/AuthContext';
import type { UserProfile, AstrologicalEvent } from '@/types/astrology/unified-types';

interface AstronomicalDay {
  date: Date;
  events: AstrologicalEvent[];
  isCurrentMonth: boolean;
  hasEvents: boolean;
}

const AgendaPersonalizada = () => {
  const { user } = useAuth();
  const [currentMonth, setCurrentMonth] = useState<Date>(new Date());
  const [selectedDate, setSelectedDate] = useState<Date | null>(null);
  const [selectedDayEvents, setSelectedDayEvents] = useState<AstrologicalEvent[]>([]);
  const [events, setEvents] = useState<AstrologicalEvent[]>([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  // Estados para modal (en lugar de tooltip)
  const [showEventModal, setShowEventModal] = useState(false);
  const [modalEvent, setModalEvent] = useState<AstrologicalEvent | null>(null);
  const [hoveredEvent, setHoveredEvent] = useState<AstrologicalEvent | null>(null);
  const [tooltipPosition, setTooltipPosition] = useState({ x: 0, y: 0 });

  // Perfil de usuario REAL (no datos de prueba)
  const [userProfile, setUserProfile] = React.useState<UserProfile | null>(null);

  React.useEffect(() => {
    const fetchUserProfile = async () => {
      if (!user?.uid) return;

      try {
        const res = await fetch(`/api/birth-data?userId=${user.uid}`);
        if (res.ok) {
          const data = await res.json();
          if (data && data.data) {
            // Calcular edad actual y pr√≥xima edad
            const birthDateObj = new Date(data.data.birthDate);
            const now = new Date();
            let currentAge = now.getFullYear() - birthDateObj.getFullYear();
            const hasHadBirthdayThisYear = (now.getMonth() > birthDateObj.getMonth()) || (now.getMonth() === birthDateObj.getMonth() && now.getDate() >= birthDateObj.getDate());
            if (!hasHadBirthdayThisYear) currentAge -= 1;
            const nextAge = currentAge + 1;

            setUserProfile({
              userId: user.uid,
              name: user.displayName || 'Usuario',
              birthDate: data.data.birthDate,
              birthTime: data.data.birthTime || '',
              birthPlace: data.data.birthPlace || '',
              currentAge,
              nextAge,
              latitude: data.data.latitude || 0,
              longitude: data.data.longitude || 0,
              timezone: data.data.timezone || '',
              place: data.data.birthPlace || '',
              astrological: data.data.astrological || undefined
            });
          }
        }
      } catch (error) {
        console.error('Error fetching user profile:', error);
      }
    };

    fetchUserProfile();
  }, [user]);

  // Eventos de ejemplo √âPICOS con variedad visual
  const generateExampleEvents = (): AstrologicalEvent[] => {
    if (!userProfile) return [];

    return [
      // Fases Lunares (4 por mes)
      {
        id: 'luna-nueva-sept',
        date: '2025-09-02',
        title: 'Luna Nueva en Virgo',
        description: 'Momento perfecto para nuevos comienzos y organizaci√≥n',
        type: 'lunar_phase',
        priority: 'high',
        planet: 'Luna',
        sign: 'Virgo',
        aiInterpretation: {
          meaning: `¬°REVOLUCI√ìN ORGANIZATIVA ${userProfile.name?.toUpperCase()}! Como G√©minis con ${userProfile.currentAge} a√±os, esta Luna Nueva en Virgo te ayuda a estructurar tu mente curiosa.`,
          advice: 'ORGANIZA tus ideas y proyectos. Tu Mercurio en G√©minis necesita esta energ√≠a Virgo para dar forma pr√°ctica a tu creatividad.',
          mantra: 'SOY ORDEN Y CREATIVIDAD EN PERFECTA ARMON√çA.',
          ritual: 'Escribe una lista de 3 proyectos que quieres organizar y dedica 10 minutos diarios a trabajar en ellos.',
          lifeAreas: ['Organizaci√≥n', 'Estudio', 'Rutinas']
        }
      },
      {
        id: 'luna-llena-sept',
        date: '2025-09-17',
        title: 'Luna Llena en Piscis',
        description: 'Culminaci√≥n emocional e intuici√≥n elevada',
        type: 'lunar_phase',
        priority: 'high',
        planet: 'Luna',
        sign: 'Piscis',
        aiInterpretation: {
          meaning: `¬°ACTIVACI√ìN EMOCIONAL PROFUNDA ${userProfile.name?.toUpperCase()}! Tu Luna en C√°ncer resuena con esta energ√≠a Piscis.`,
          advice: 'CONF√çA en tu intuici√≥n. A los ${userProfile.currentAge} a√±os, desarrollas tu sensibilidad emocional - esta luna te conecta con tu mundo interior.',
          mantra: 'MI INTUICI√ìN ME GU√çA HACIA MIS SUE√ëOS M√ÅS PROFUNDOS.',
          ritual: 'Meditaci√≥n de 5 minutos conectando con tus emociones y escribiendo un sue√±o que hayas tenido recientemente.',
          lifeAreas: ['Emociones', 'Intuici√≥n', 'Creatividad']
        }
      },

      // Tr√°nsitos Planetarios
      {
        id: 'mercurio-geminis',
        date: '2025-09-05',
        title: 'Mercurio entra en Libra',
        description: 'Tu planeta regente mejora tu comunicaci√≥n y relaciones',
        type: 'planetary_transit',
        priority: 'medium',
        planet: 'Mercurio',
        sign: 'Libra',
        aiInterpretation: {
          meaning: `¬°UPGRADE COMUNICATIVO √âPICO! Tu Mercurio natal en G√©minis recibe apoyo de Libra para equilibrar tu expresi√≥n.`,
          advice: 'APROVECHA para mejorar tus relaciones sociales. Como G√©minis, tu don de comunicaci√≥n se refina con diplomatismo.',
          mantra: 'MIS PALABRAS CREAN ARMON√çA Y CONEXIONES AUT√âNTICAS.',
          ritual: 'Escribe una carta o mensaje positivo a un amigo o familiar expresando tu gratitud.',
          lifeAreas: ['Comunicaci√≥n', 'Relaciones', 'Social']
        }
      },

      // Retrogradaciones
      {
        id: 'venus-retrogrado',
        date: '2025-09-12',
        title: 'Venus Retr√≥grado en Escorpio',
        description: 'Revisi√≥n profunda de valores y relaciones',
        type: 'retrograde',
        priority: 'medium',
        planet: 'Venus',
        sign: 'Escorpio',
        aiInterpretation: {
          meaning: `MOMENTO DE REFLEXI√ìN VENUSINA. Con ${userProfile.currentAge} a√±os, es perfecto para entender qu√© valoras realmente en las amistades.`,
          advice: 'REFLEXIONA sobre tus relaciones. ¬øCu√°les son aut√©nticas? Tu Venus en Tauro busca estabilidad emocional.',
          mantra: 'RECONOZCO LO QUE VERDADERAMENTE VALORO EN MI CORAZ√ìN.',
          ritual: 'Haz una lista de 5 cosas que valoras en tus amistades m√°s importantes.',
          lifeAreas: ['Relaciones', 'Valores', 'Autoestima']
        }
      },

      // Aspectos importantes
      {
        id: 'sol-jupiter-trigono',
        date: '2025-09-20',
        title: 'Sol tr√≠gono J√∫piter',
        description: 'Expansi√≥n, oportunidades y optimismo',
        type: 'aspect',
        priority: 'high',
        planet: 'Sol',
        sign: 'G√©minis',
        aiInterpretation: {
          meaning: `¬°EXPANSI√ìN SOLAR √âPICA ${userProfile.name?.toUpperCase()}! Tu Sol G√©minis se conecta con la abundancia jupiteriana.`,
          advice: 'ABRAZA nuevas oportunidades de aprendizaje. Es momento perfecto para cursos, idiomas o habilidades que ampl√≠en tu mundo.',
          mantra: 'ME EXPANDO CON CONFIANZA HACIA NUEVOS HORIZONTES DE CONOCIMIENTO.',
          ritual: 'Investiga sobre un tema que te interese y dedica 15 minutos diarios a aprender algo nuevo.',
          lifeAreas: ['Aprendizaje', 'Crecimiento', 'Oportunidades']
        }
      },

      // M√°s eventos distribuidos
      {
        id: 'marte-virgo',
        date: '2025-09-08',
        title: 'Marte entra en Virgo',
        description: 'Energ√≠a enfocada en perfeccionamiento y rutinas',
        type: 'planetary_transit',
        priority: 'low',
        planet: 'Marte',
        sign: 'Virgo',
        aiInterpretation: {
          meaning: `ORGANIZACI√ìN ENERG√âTICA. Tu Marte en Virgo se activa para dar estructura a tu energ√≠a G√©minis.`,
          advice: 'CREA rutinas que te ayuden a enfocar tu mente dispersa. Peque√±os h√°bitos diarios har√°n gran diferencia.',
          mantra: 'CANALIZO MI ENERG√çA CON PRECISI√ìN Y PROP√ìSITO.',
          ritual: 'Crea una rutina matutina de 10 minutos que incluya organizaci√≥n y planificaci√≥n del d√≠a.',
          lifeAreas: ['Rutinas', 'Productividad', 'Salud']
        }
      },

      {
        id: 'eclipse-solar',
        date: '2025-09-25',
        title: 'Eclipse Solar en Libra',
        description: 'Portal de transformaci√≥n en relaciones',
        type: 'eclipse',
        priority: 'high',
        planet: 'Sol',
        sign: 'Libra',
        aiInterpretation: {
          meaning: `¬°PORTAL ECLIPSE TRANSFORMADOR! Este eclipse activa tu Casa de relaciones y comunicaci√≥n equilibrada.`,
          advice: 'PREP√ÅRATE para cambios importantes en c√≥mo te relacionas. Tu Ascendente Leo brilla con nueva diplomatismo.',
          mantra: 'SOY EQUILIBRIO Y ARMON√çA EN TODAS MIS RELACIONES.',
          ritual: 'Reflexiona sobre una relaci√≥n importante en tu vida y escribe c√≥mo puedes mejorarla.',
          lifeAreas: ['Relaciones', 'Equilibrio', 'Transformaci√≥n']
        }
      }
    ];
  };

  // Cargar eventos al iniciar
  useEffect(() => {
    if (!userProfile) return;

    const exampleEvents = generateExampleEvents();
    // Generar m√°s eventos para llenar el mes
    const additionalEvents = [];
    for (let day = 1; day <= 30; day++) {
      if (Math.random() > 0.7) { // 30% probabilidad de evento
        additionalEvents.push({
          id: `day-${day}`,
          date: `2025-09-${day.toString().padStart(2, '0')}`,
          title: getRandomEventTitle(),
          description: 'Evento astrol√≥gico personalizado para tu evoluci√≥n',
          type: getRandomEventType(),
          priority: getRandomImportance() as 'high' | 'medium' | 'low',
          planet: getRandomPlanet(),
          sign: getRandomSign(),
          aiInterpretation: {
            meaning: `¬°ACTIVACI√ìN ESPEC√çFICA para ${userProfile.name}!`,
            advice: 'Consejo personalizado basado en tu carta natal',
            mantra: 'MANTRA ESPEC√çFICO para tu evoluci√≥n',
            ritual: 'Ritual personalizado para este evento',
            lifeAreas: ['Crecimiento', 'Autoconocimiento']
          }
        });
      }
    }
    setEvents([...exampleEvents, ...additionalEvents]);
  }, [userProfile]);

  // Funciones auxiliares
  const getRandomEventTitle = () => {
    const titles = [
      'Activaci√≥n Solar √âpica', 'Resonancia Lunar Profunda', 'Portal de Manifestaci√≥n',
      'Tr√≠gono Venus-J√∫piter', 'Conjunci√≥n Mercurio-Urano', 'Despertar de Plut√≥n',
      'Bendici√≥n de J√∫piter', 'Sabidur√≠a de Saturno', 'Magia Venusina'
    ];
    return titles[Math.floor(Math.random() * titles.length)];
  };

  const getRandomEventType = () => {
    const types = ['ai_generated', 'lunar_phase', 'planetary_transit', 'aspect', 'eclipse'];
    return types[Math.floor(Math.random() * types.length)];
  };

  const getRandomImportance = () => {
    const importances = ['high', 'medium', 'low'];
    return importances[Math.floor(Math.random() * importances.length)];
  };

  const getRandomPlanet = () => {
    const planets = ['Sol', 'Luna', 'Mercurio', 'Venus', 'Marte', 'J√∫piter', 'Saturno', 'Urano', 'Neptuno', 'Plut√≥n'];
    return planets[Math.floor(Math.random() * planets.length)];
  };

  const getRandomSign = () => {
    const signs = ['Aries', 'Tauro', 'G√©minis', 'C√°ncer', 'Leo', 'Virgo', 'Libra', 'Escorpio', 'Sagitario', 'Capricornio', 'Acuario', 'Piscis'];
    return signs[Math.floor(Math.random() * signs.length)];
  };

  // Navegaci√≥n del calendario
  const getDaysWithEvents = () => {
    const monthStart = startOfMonth(currentMonth);
    const monthEnd = endOfMonth(monthStart);
    const startDate = new Date(monthStart);
    startDate.setDate(startDate.getDate() - monthStart.getDay() + 1);
    const endDate = new Date(monthEnd);
    endDate.setDate(endDate.getDate() + (7 - monthEnd.getDay()));

    const days = eachDayOfInterval({ start: startDate, end: endDate });

    return days.map(day => {
      const dayEvents = events.filter(event => {
        const eventDate = new Date(event.date);
        return isSameDay(day, eventDate);
      });

      return {
        date: day,
        events: dayEvents,
        isCurrentMonth: isSameMonth(day, currentMonth),
        hasEvents: dayEvents.length > 0
      };
    });
  };

  const goToPreviousMonth = () => {
    setCurrentMonth(prev => subMonths(prev, 1));
    setSelectedDate(null);
    setSelectedDayEvents([]);
  };

  const goToNextMonth = () => {
    setCurrentMonth(prev => addMonths(prev, 1));
    setSelectedDate(null);
    setSelectedDayEvents([]);
  };

  const getCurrentMonthName = () => {
    return format(currentMonth, 'MMMM yyyy', { locale: es });
  };

  const handleDayClick = (day: AstronomicalDay) => {
    setSelectedDate(day.date);
    setSelectedDayEvents(day.events);
  };

  // Modal handlers (reemplaza tooltip)
  const handleEventClick = (event: AstrologicalEvent) => {
    setModalEvent(event);
    setShowEventModal(true);
  };

  const closeEventModal = () => {
    setShowEventModal(false);
    setModalEvent(null);
  };

  // Tooltip handlers
  const handleEventHover = (event: AstrologicalEvent, e: React.MouseEvent) => {
    setHoveredEvent(event);
    setTooltipPosition({ x: e.clientX, y: e.clientY });
  };

  const handleEventLeave = () => {
    setHoveredEvent(null);
  };

  // Obtener icono para evento (m√°s variedad visual)
  const getEventIcon = (type: string, priority?: string) => {
    if (priority === 'high') {
      return 'üî•';
    }

    switch (type) {
      case 'lunar_phase': return 'üåô';
      case 'planetary_transit': return 'ü™ê';
      case 'retrograde': return '‚è™';
      case 'direct': return '‚ñ∂Ô∏è';
      case 'eclipse': return 'üåë';
      case 'aspect': return '‚ú®';
      case 'ai_generated': return 'üöÄ';
      default: return '‚≠ê';
    }
  };

  // Obtener color de evento
  const getEventColor = (type: string, priority?: string) => {
    if (priority === 'high') {
      return 'from-red-500 to-orange-500';
    }

    switch (type) {
      case 'lunar_phase': return 'from-indigo-500 to-purple-500';
      case 'planetary_transit': return 'from-blue-500 to-cyan-500';
      case 'eclipse': return 'from-purple-600 to-pink-600';
      case 'aspect': return 'from-yellow-500 to-amber-500';
      case 'ai_generated': return 'from-emerald-500 to-teal-500';
      default: return 'from-purple-500 to-pink-500';
    }
  };

  const weekDays = ['Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b', 'Dom'];
  const days = getDaysWithEvents();

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-indigo-900 relative overflow-hidden">
      
      {/* Part√≠culas m√°gicas de fondo */}
      <div className="absolute inset-0 overflow-hidden pointer-events-none">
        <div className="absolute top-10 left-10 w-2 h-2 bg-yellow-400 rounded-full animate-pulse opacity-60"></div>
        <div className="absolute top-20 right-20 w-1 h-1 bg-pink-400 rounded-full animate-ping opacity-40"></div>
        <div className="absolute bottom-20 left-20 w-3 h-3 bg-purple-400 rounded-full animate-pulse opacity-50"></div>
        <div className="absolute bottom-10 right-10 w-2 h-2 bg-cyan-400 rounded-full animate-ping opacity-60"></div>
      </div>

      <div className="relative z-10 max-w-7xl mx-auto p-4 lg:p-8">
        
        {/* HEADER √âPICO INSPIRADO EN DASHBOARD */}
        <div className="text-center mb-16">
          <div className="flex justify-center items-center mb-8">
            <div className="bg-gradient-to-r from-yellow-400/20 to-orange-500/20 border border-yellow-400/30 rounded-full p-8 backdrop-blur-sm relative">
              <div className="absolute -top-2 -right-2 w-4 h-4 bg-yellow-400 rounded-full animate-pulse"></div>
              <div className="absolute -bottom-1 -left-1 w-3 h-3 bg-orange-400 rounded-full animate-bounce"></div>
              <span className="text-5xl">üöÄ</span>
            </div>
          </div>

          <h1 className="text-4xl md:text-6xl font-black mb-6 leading-tight text-white">
            Bienvenido a tu
            <span className="bg-gradient-to-r from-yellow-400 via-orange-500 to-pink-500 bg-clip-text text-transparent"> agenda c√≥smica</span>
          </h1>

          <div className="max-w-3xl mx-auto">
            <p className="text-xl text-gray-300 mb-6 leading-relaxed">
              {userProfile?.name ? `‚ú® Hola ${userProfile.name}, ` : '‚ú® Hola, explorador c√≥smico, '}
              aqu√≠ encontrar√°s tu calendario astrol√≥gico personalizado con eventos c√≥smicos importantes y momentos de poder personal.
            </p>

            {/* Texto de personalidad con modal */}
            {userProfile && userProfile.progressedInterpretation && (
              <>
                <p className="text-gray-400 mb-4 line-clamp-3">
                  {userProfile.progressedInterpretation.summary}
                </p>
                <button
                  onClick={() => setShowPersonalityModal(true)}
                  className="text-yellow-400 underline hover:text-yellow-300 transition-colors duration-200"
                >
                  Continuar leyendo...
                </button>

                {showPersonalityModal && (
                  <>
                    <div
                      className="fixed inset-0 bg-black/70 backdrop-blur-sm z-50"
                      onClick={() => setShowPersonalityModal(false)}
                    />
                    <div className="fixed inset-0 flex items-center justify-center z-50 p-6">
                      <div className="bg-gradient-to-br from-purple-900/95 to-pink-900/95 backdrop-blur-sm border border-purple-400/40 rounded-3xl shadow-2xl max-w-3xl w-full max-h-[80vh] overflow-y-auto p-6 text-white">
                        <h3 className="text-2xl font-bold mb-4">Perfil de Personalidad</h3>
                        <p className="whitespace-pre-line leading-relaxed">
                          {userProfile.progressedInterpretation.fullText}
                        </p>
                        <button
                          onClick={() => setShowPersonalityModal(false)}
                          className="mt-6 bg-gradient-to-r from-yellow-400 to-orange-500 px-6 py-2 rounded-full font-semibold hover:from-yellow-300 hover:to-orange-400 transition-all duration-200 shadow-lg"
                        >
                          Cerrar
                        </button>
                      </div>
                    </div>
                  </>
                )}
              </>
            )}

            {/* Estad√≠sticas de progreso */}
            <div className="flex justify-center items-center space-x-6 text-sm">
              <div className="flex items-center bg-white/10 backdrop-blur-sm rounded-full px-4 py-2">
                <span className="text-green-300">üåô</span>
                <span className="text-green-300 ml-2">Fases Lunares</span>
              </div>
              <div className="flex items-center bg-white/10 backdrop-blur-sm rounded-full px-4 py-2">
                <span className="text-blue-300">‚≠ê</span>
                <span className="text-blue-300 ml-2">Tr√°nsitos</span>
              </div>
              <div className="flex items-center bg-white/10 backdrop-blur-sm rounded-full px-4 py-2">
                <span className="text-pink-300">‚ú®</span>
                <span className="text-pink-300 ml-2">Eventos √âpicos</span>
              </div>
            </div>
          </div>
        </div>

        {/* LAYOUT DESKTOP/MOBILE */}
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
          
          {/* CALENDARIO PRINCIPAL - 2/3 en desktop */}
          <div className="lg:col-span-2">
            
            {/* Header del calendario */}
            <div className="bg-gradient-to-r from-purple-600/30 to-indigo-600/30 backdrop-blur-sm rounded-2xl p-6 mb-6 border border-purple-400/30">
              <div className="flex items-center justify-between">
                <h2 className="text-2xl lg:text-3xl font-bold text-white capitalize flex items-center">
                  <span className="mr-3">üóìÔ∏è</span>
                  {getCurrentMonthName()}
                </h2>
                
                {/* Navegaci√≥n */}
                <div className="flex items-center gap-3">
                  <button
                    onClick={goToPreviousMonth}
                    className="p-3 rounded-xl bg-gradient-to-r from-purple-500/80 to-indigo-500/80 hover:from-purple-400/90 hover:to-indigo-400/90 transition-all duration-200 shadow-lg hover:shadow-purple-500/25 border border-white/10 group"
                  >
                    <svg className="h-5 w-5 text-white group-hover:scale-110 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                    </svg>
                  </button>
                  
                  <button
                    onClick={goToNextMonth}
                    className="p-3 rounded-xl bg-gradient-to-r from-purple-500/80 to-indigo-500/80 hover:from-purple-400/90 hover:to-indigo-400/90 transition-all duration-200 shadow-lg hover:shadow-purple-500/25 border border-white/10 group"
                  >
                    <svg className="h-5 w-5 text-white group-hover:scale-110 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                    </svg>
                  </button>
                </div>
              </div>
            </div>

            {/* Calendario grid */}
            <div className="bg-gradient-to-br from-purple-900/20 to-indigo-900/20 backdrop-blur-sm rounded-2xl shadow-2xl border border-purple-400/20 overflow-hidden">
              
              {/* D√≠as de la semana */}
              <div className="grid grid-cols-7 bg-gradient-to-r from-purple-700/50 to-indigo-700/50">
                {weekDays.map((day, index) => (
                  <div key={index} className="py-4 text-center text-sm font-bold text-purple-100 border-r border-purple-400/20 last:border-r-0">
                    {day}
                  </div>
                ))}
              </div>

              {/* D√≠as del mes */}
              <div className="grid grid-cols-7">
                {days.map((day, index) => {
                  const isToday = isSameDay(day.date, new Date());
                  const isSelected = selectedDate && isSameDay(day.date, selectedDate);
                  
                  return (
                    <div
                      key={index}
                      onClick={() => handleDayClick(day)}
                      className={`
                        relative min-h-[100px] lg:min-h-[120px] p-2 lg:p-3 cursor-pointer transition-all duration-300 border-r border-b border-purple-400/20 last:border-r-0 group
                        ${day.isCurrentMonth
                          ? isToday
                            ? 'bg-gradient-to-br from-yellow-500/20 to-orange-500/20 border-2 border-yellow-400/50 shadow-lg shadow-yellow-500/20'
                            : isSelected
                            ? 'bg-gradient-to-br from-purple-500/30 to-pink-500/30 border-2 border-purple-400/60'
                            : 'bg-gradient-to-br from-purple-800/10 to-indigo-800/10 hover:from-purple-600/20 hover:to-indigo-600/20'
                          : 'bg-gradient-to-br from-gray-800/20 to-slate-800/20 text-gray-500'
                        }
                      `}
                    >
                      {/* N√∫mero del d√≠a */}
                      <div className={`
                        text-sm lg:text-base font-bold mb-2
                        ${isToday ? 'text-yellow-300' : day.isCurrentMonth ? 'text-white' : 'text-gray-500'}
                      `}>
                        {day.date.getDate()}
                      </div>

                      {/* Eventos del d√≠a con iconos */}
                      {day.hasEvents && (
                        <div className="space-y-1">
                          {day.events.slice(0, 2).map((event, eventIndex) => (
                            <div
                              key={eventIndex}
                              onClick={(e) => {
                                e.stopPropagation();
                                handleEventClick(event);
                              }}
                              className={`
                                flex items-center gap-1 p-1 rounded-lg cursor-pointer transition-all duration-200 group-hover:scale-105
                                bg-gradient-to-r ${getEventColor(event.type, event.priority)} bg-opacity-80 backdrop-blur-sm
                                hover:shadow-lg hover:shadow-purple-500/30
                              `}
                            >
                              <span className="text-xs lg:text-sm">{getEventIcon(event.type, event.priority)}</span>
                              <span className="text-white text-xs font-medium truncate flex-1">
                                {event.title}
                              </span>
                              {event.priority === 'high' && (
                                <span className="text-yellow-300 text-xs animate-pulse">!</span>
                              )}
                            </div>
                          ))}
                          
                          {day.events.length > 2 && (
                            <div className="text-purple-300 text-xs font-medium text-center bg-purple-600/20 rounded px-2 py-1">
                              +{day.events.length - 2} m√°s
                            </div>
                          )}
                        </div>
                      )}

                      {/* Efecto hover */}
                      <div className="absolute inset-0 border-2 border-transparent group-hover:border-purple-400/40 rounded-lg transition-colors duration-200 pointer-events-none"></div>
                    </div>
                  );
                })}
              </div>
            </div>
          </div>

          {/* SIDEBAR EVENTOS - 1/3 en desktop */}
          <div className="lg:col-span-1">
            <div className="sticky top-8">

              {/* Info del usuario - MOVIDO ARRIBA */}
              {userProfile && (
                <div className="bg-gradient-to-br from-white/10 to-white/5 backdrop-blur-sm border border-white/20 rounded-3xl p-6 mb-6 relative overflow-hidden">
                  <div className="absolute top-4 right-4 w-3 h-3 bg-green-400 rounded-full animate-pulse"></div>
                  <div className="absolute bottom-4 left-4 w-2 h-2 bg-blue-400 rounded-full animate-bounce"></div>

                  <div className="flex items-center mb-4">
                    <div className="bg-gradient-to-r from-green-400/20 to-blue-500/20 border border-green-400/30 rounded-full p-3 backdrop-blur-sm mr-4">
                      <span className="text-2xl">üë§</span>
                    </div>
                    <div>
                      <h4 className="text-lg font-bold text-white">{userProfile.name || 'Usuario'}</h4>
                      <p className="text-gray-300 text-sm">{userProfile.currentAge || 0} a√±os</p>
                    </div>
                  </div>

                  <div className="space-y-3">
                    <div className="bg-black/30 rounded-xl p-3 border border-white/10">
                      <div className="flex items-center justify-between">
                        <span className="text-gray-400 text-xs">Lugar</span>
                        <span className="text-white text-sm">üìç {userProfile.place || 'Sin ubicaci√≥n'}</span>
                      </div>
                    </div>

                    <div className="bg-black/30 rounded-xl p-3 border border-white/10">
                      <div className="text-gray-400 text-xs mb-2">Signos Astrol√≥gicos</div>
                      <div className="space-y-1">
                        <div className="flex items-center justify-between">
                          <span className="text-yellow-300 text-xs">‚òâ Sol</span>
                          <span className="text-white text-sm">{userProfile.astrological?.signs?.sun || 'N/A'}</span>
                        </div>
                        <div className="flex items-center justify-between">
                          <span className="text-blue-300 text-xs">‚òΩ Luna</span>
                          <span className="text-white text-sm">{userProfile.astrological?.signs?.moon || 'N/A'}</span>
                        </div>
                        <div className="flex items-center justify-between">
                          <span className="text-purple-300 text-xs">‚Üó Ascendente</span>
                          <span className="text-white text-sm">{userProfile.astrological?.signs?.ascendant || 'N/A'}</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              )}

              {/* Header del sidebar */}
              <div className="bg-gradient-to-r from-pink-600/30 to-purple-600/30 backdrop-blur-sm rounded-2xl p-6 mb-6 border border-pink-400/30">
                <h3 className="text-xl font-bold text-white mb-2 flex items-center">
                  <span className="mr-3">üìÖ</span>
                  {selectedDate
                    ? `${selectedDate.getDate()} de ${format(selectedDate, 'MMMM', { locale: es })}`
                    : 'Selecciona un d√≠a'
                  }
                </h3>
                <p className="text-pink-200 text-sm">
                  {selectedDayEvents.length === 0
                    ? 'Haz click en un d√≠a para ver sus eventos'
                    : `${selectedDayEvents.length} evento${selectedDayEvents.length > 1 ? 's' : ''} c√≥smico${selectedDayEvents.length > 1 ? 's' : ''}`
                  }
                </p>
              </div>

              {/* Lista de eventos */}
              {selectedDayEvents.length > 0 && (
                <div className="space-y-4 max-h-[600px] overflow-y-auto">
                  {selectedDayEvents.map((event) => (
                    <div
                      key={event.id}
                      className={`
                        bg-gradient-to-r ${getEventColor(event.type, event.priority)}/20 backdrop-blur-sm
                        rounded-2xl p-4 border border-white/20 hover:shadow-lg transition-all duration-200
                        cursor-pointer hover:scale-105
                      `}
                      onMouseEnter={(e) => handleEventHover(event, e)}
                      onMouseLeave={handleEventLeave}
                    >
                      <div className="flex items-start justify-between mb-3">
                        <div className="flex items-center gap-3">
                          <span className="text-2xl">{getEventIcon(event.type, event.priority)}</span>
                          <div>
                            <h4 className="font-bold text-white text-sm lg:text-base">{event.title}</h4>
                            {event.planet && event.sign && (
                              <p className="text-purple-200 text-xs">{event.planet} en {event.sign}</p>
                            )}
                          </div>
                        </div>
                        {event.priority === 'high' && (
                          <span className="bg-red-500/80 text-white text-xs font-bold px-2 py-1 rounded-full animate-pulse">
                            CR√çTICO
                          </span>
                        )}
                      </div>
                      
                      <p className="text-gray-200 text-sm mb-3 line-clamp-2">{event.description}</p>
                      
                      <div className="text-purple-300 text-xs italic">
                        Hover para ver interpretaci√≥n completa ‚ú®
                      </div>
                    </div>
                  ))}
                </div>
              )}

              {/* CTA inspirado en Dididaze */}
              <div className="mt-6 bg-gradient-to-r from-purple-600/40 to-pink-600/40 backdrop-blur-sm rounded-2xl p-6 border border-purple-400/30 text-center">
                <div className="text-2xl mb-3">üîÆ</div>
                <h4 className="text-white font-bold mb-2">¬øQuieres m√°s magia?</h4>
                <p className="text-purple-200 text-sm mb-4">
                  Descubre interpretaciones a√∫n m√°s profundas de tu carta natal
                </p>
                <button className="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-6 py-2 rounded-full font-semibold hover:from-purple-400 hover:to-pink-400 transition-all duration-200 shadow-lg hover:shadow-xl">
                  Explorar m√°s ‚ú®
                </button>
              </div>
            </div>
          </div>
        </div>

        {/* TOOLTIP √âPICO */}
        {hoveredEvent && hoveredEvent.aiInterpretation && (
          <div
            className="fixed bg-gradient-to-r from-purple-900/95 to-pink-900/95 backdrop-blur-sm border border-purple-400/40 rounded-2xl p-6 shadow-2xl max-w-sm pointer-events-none z-50"
            style={{
              left: Math.min(tooltipPosition.x - 200, window.innerWidth - 400),
              top: tooltipPosition.y - 20,
              transform: 'translateY(-100%)'
            }}
          >
            {/* Header */}
            <div className="flex items-center mb-4">
              <span className="text-2xl mr-3">{getEventIcon(hoveredEvent.type, hoveredEvent.priority)}</span>
              <div>
                <div className="text-white font-bold">{hoveredEvent.title}</div>
                <div className="text-purple-200 text-sm">
                  {hoveredEvent.planet && hoveredEvent.sign && `${hoveredEvent.planet} en ${hoveredEvent.sign}`}
                </div>
              </div>
            </div>

            {/* Contenido */}
            <div className="space-y-3">
              <div className="bg-white/10 rounded-lg p-3 border border-white/20">
                <div className="text-yellow-300 font-semibold text-sm mb-1 flex items-center">
                  <span className="mr-2">üî•</span>SIGNIFICADO:
                </div>
                <div className="text-white text-sm leading-relaxed">
                  {hoveredEvent.aiInterpretation.meaning}
                </div>
              </div>

              <div className="bg-white/10 rounded-lg p-3 border border-white/20">
                <div className="text-emerald-300 font-semibold text-sm mb-1 flex items-center">
                  <span className="mr-2">‚ö°</span>CONSEJO:
                </div>
                <div className="text-white text-sm leading-relaxed">
                  {hoveredEvent.aiInterpretation.advice}
                </div>
              </div>

              {hoveredEvent.aiInterpretation.mantra && (
                <div className="bg-gradient-to-r from-yellow-500/20 to-orange-500/20 border border-yellow-400/30 rounded-lg p-3 text-center">
                  <div className="text-yellow-300 font-semibold text-sm mb-1">‚ú® MANTRA:</div>
                  <div className="text-white text-sm font-medium italic">
                    "{hoveredEvent.aiInterpretation.mantra}"
                  </div>
                </div>
              )}
            </div>
          </div>
        )}

        {/* MODAL CENTRADO CON OVERLAY */}
        {showEventModal && modalEvent && (
          <>
            {/* Overlay */}
            <div
              className="fixed inset-0 bg-black/60 backdrop-blur-sm z-40"
              onClick={closeEventModal}
            />

            {/* Modal centrado */}
            <div className="fixed inset-0 flex items-center justify-center z-50 p-4">
              <div className="bg-gradient-to-br from-purple-900/95 to-pink-900/95 backdrop-blur-sm border border-purple-400/40 rounded-3xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-hidden">
                {/* Header del modal */}
                <div className="bg-gradient-to-r from-purple-600/80 to-pink-600/80 p-6 border-b border-white/20">
                  <div className="flex items-center justify-between">
                    <div className="flex items-center gap-4">
                      <span className="text-4xl">{getEventIcon(modalEvent.type, modalEvent.priority)}</span>
                      <div>
                        <h2 className="text-2xl font-bold text-white">{modalEvent.title}</h2>
                        <p className="text-purple-200 text-sm">
                          {new Date(modalEvent.date).toLocaleDateString('es-ES', {
                            weekday: 'long',
                            day: 'numeric',
                            month: 'long',
                            year: 'numeric'
                          })}
                        </p>
                        {modalEvent.planet && modalEvent.sign && (
                          <p className="text-purple-300 text-xs mt-1">
                            {modalEvent.planet} en {modalEvent.sign}
                          </p>
                        )}
                      </div>
                    </div>

                    {/* Bot√≥n cerrar */}
                    <button
                      onClick={closeEventModal}
                      className="p-2 rounded-full bg-white/10 hover:bg-white/20 transition-colors duration-200"
                    >
                      <svg className="w-6 h-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                      </svg>
                    </button>
                  </div>

                  {/* Nivel de importancia */}
                  {modalEvent.priority === 'high' && (
                    <div className="mt-4 inline-flex items-center gap-2 bg-red-500/20 border border-red-400/30 rounded-full px-4 py-2">
                      <span className="text-red-300 text-sm font-medium">üî• PRIORIDAD CR√çTICA</span>
                    </div>
                  )}
                </div>

                {/* Contenido del modal con scroll */}
                <div className="p-6 max-h-[60vh] overflow-y-auto">
                  {/* Descripci√≥n */}
                  <div className="mb-6">
                    <h3 className="text-lg font-semibold text-white mb-3 flex items-center">
                      <span className="text-purple-300 mr-2">üìù</span>
                      Descripci√≥n del Evento
                    </h3>
                    <p className="text-gray-200 leading-relaxed">{modalEvent.description}</p>
                  </div>

                  {/* Interpretaci√≥n personalizada */}
                  {modalEvent.aiInterpretation && (
                    <div className="space-y-6">
                      {/* Significado √©pico */}
                      <div className="bg-gradient-to-r from-yellow-500/10 to-orange-500/10 border border-yellow-400/20 rounded-2xl p-5">
                        <h3 className="text-lg font-semibold text-yellow-300 mb-3 flex items-center">
                          <span className="mr-2">üî•</span>
                          SIGNIFICADO √âPICO
                        </h3>
                        <p className="text-white leading-relaxed">{modalEvent.aiInterpretation.meaning}</p>
                      </div>

                      {/* Consejo revolucionario */}
                      <div className="bg-gradient-to-r from-emerald-500/10 to-teal-500/10 border border-emerald-400/20 rounded-2xl p-5">
                        <h3 className="text-lg font-semibold text-emerald-300 mb-3 flex items-center">
                          <span className="mr-2">‚ö°</span>
                          CONSEJO REVOLUCIONARIO
                        </h3>
                        <p className="text-white leading-relaxed">{modalEvent.aiInterpretation.advice}</p>
                      </div>

                      {/* Mantra */}
                      {modalEvent.aiInterpretation.mantra && (
                        <div className="bg-gradient-to-r from-purple-500/10 to-pink-500/10 border border-purple-400/20 rounded-2xl p-5 text-center">
                          <h3 className="text-lg font-semibold text-purple-300 mb-3 flex items-center justify-center">
                            <span className="mr-2">‚ú®</span>
                            MANTRA DE PODER
                          </h3>
                          <p className="text-white text-lg font-medium italic">
                            "{modalEvent.aiInterpretation.mantra}"
                          </p>
                        </div>
                      )}

                      {/* Ritual opcional */}
                      {modalEvent.aiInterpretation.ritual && (
                        <div className="bg-gradient-to-r from-indigo-500/10 to-blue-500/10 border border-indigo-400/20 rounded-2xl p-5">
                          <h3 className="text-lg font-semibold text-indigo-300 mb-3 flex items-center">
                            <span className="mr-2">üîÆ</span>
                            RITUAL RECOMENDADO
                          </h3>
                          <p className="text-white leading-relaxed">{modalEvent.aiInterpretation.ritual}</p>
                        </div>
                      )}

                      {/* √Åreas de vida activadas */}
                      {modalEvent.aiInterpretation.lifeAreas && (
                        <div className="bg-gradient-to-r from-cyan-500/10 to-blue-500/10 border border-cyan-400/20 rounded-2xl p-5">
                          <h3 className="text-lg font-semibold text-cyan-300 mb-3 flex items-center">
                            <span className="mr-2">üéØ</span>
                            √ÅREAS DE VIDA ACTIVADAS
                          </h3>
                          <div className="flex flex-wrap gap-2">
                            {modalEvent.aiInterpretation.lifeAreas.map((area: string, index: number) => (
                              <span key={index} className="bg-cyan-500/20 border border-cyan-400/30 text-cyan-200 px-3 py-1 rounded-full text-sm">
                                {area}
                              </span>
                            ))}
                          </div>
                        </div>
                      )}
                    </div>
                  )}
                </div>

                {/* Footer del modal */}
                <div className="bg-gradient-to-r from-purple-600/80 to-pink-600/80 p-6 border-t border-white/20">
                  <div className="flex items-center justify-between">
                    <div className="text-purple-200 text-sm">
                      <span className="font-medium">Tipo:</span> {modalEvent.type.replace('_', ' ').toUpperCase()}
                    </div>
                    <button
                      onClick={closeEventModal}
                      className="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-6 py-2 rounded-full font-semibold hover:from-purple-400 hover:to-pink-400 transition-all duration-200 shadow-lg"
                    >
                      Cerrar ‚ú®
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </>
        )}
      </div>
    </div>
  );
};

export default AgendaPersonalizada;