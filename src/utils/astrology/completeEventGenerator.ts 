// src/utils/astrology/completeEventGenerator.ts - CORREGIDO PARA PER√çODO COMPLETO
// ‚úÖ PROBLEMA RESUELTO: Genera eventos desde √∫ltimo cumplea√±os hasta pr√≥ximo cumplea√±os

import { AstrologicalEvent, UserProfile, ZODIAC_SIGNS, normalizeEvent } from '@/types/astrology/unified-types';
import { addDays, addMonths, format, differenceInDays, isBefore, isAfter } from 'date-fns';

export interface EventGenerationOptions {
  userProfile: UserProfile;
  includeAllYear?: boolean;
  eventsPerMonth?: number;
}

export function generateCompleteEventCalendar(options: EventGenerationOptions): AstrologicalEvent[] {
  const { userProfile, includeAllYear = true, eventsPerMonth = 8 } = options;
  const events: AstrologicalEvent[] = [];
  
  console.log('üéÇ Generando eventos completos para:', userProfile.name, userProfile.currentAge, 'a√±os');
  
  // ‚úÖ CALCULAR FECHAS CORRECTAS: √öLTIMO CUMPLEA√ëOS ‚Üí PR√ìXIMO CUMPLEA√ëOS
  const today = new Date();
  const currentYear = today.getFullYear();
  const birthMonth = parseInt(userProfile.birthDate.split('-')[1]) - 1; // 0-indexed
  const birthDay = parseInt(userProfile.birthDate.split('-')[2]);
  
  // ‚úÖ √öLTIMO CUMPLEA√ëOS (inicio del per√≠odo)
  let lastBirthday = new Date(currentYear, birthMonth, birthDay);
  if (isAfter(lastBirthday, today)) {
    lastBirthday = new Date(currentYear - 1, birthMonth, birthDay);
  }
  
  // ‚úÖ PR√ìXIMO CUMPLEA√ëOS (final del per√≠odo)
  let nextBirthday = new Date(currentYear, birthMonth, birthDay);
  if (isBefore(nextBirthday, today)) {
    nextBirthday = new Date(currentYear + 1, birthMonth, birthDay);
  }
  
  console.log('üìÖ Per√≠odo CORRECTO de eventos:', {
    desde: format(lastBirthday, 'yyyy-MM-dd'),
    hasta: format(nextBirthday, 'yyyy-MM-dd'),
    hoy: format(today, 'yyyy-MM-dd'),
    totalD√≠as: differenceInDays(nextBirthday, lastBirthday)
  });
  
  // 1. ‚úÖ EVENTOS PASADOS: Del √∫ltimo cumplea√±os hasta hoy
  if (isBefore(lastBirthday, today)) {
    const pastEvents = generateEventsForPeriod(lastBirthday, today, userProfile, 'past');
    events.push(...pastEvents);
    console.log(`üìö Eventos pasados generados: ${pastEvents.length}`);
  }
  
  // 2. ‚úÖ EVENTOS FUTUROS: De hoy hasta pr√≥ximo cumplea√±os
  if (isBefore(today, nextBirthday)) {
    const futureEvents = generateEventsForPeriod(today, nextBirthday, userProfile, 'future');
    events.push(...futureEvents);
    console.log(`üîÆ Eventos futuros generados: ${futureEvents.length}`);
  }
  
  // 3. ‚úÖ EVENTOS ESPECIALES ADICIONALES
  if (includeAllYear) {
    const specialEvents = generateSpecialEvents(lastBirthday, nextBirthday, userProfile);
    events.push(...specialEvents);
    console.log(`‚≠ê Eventos especiales agregados: ${specialEvents.length}`);
  }
  
  // Ordenar por fecha y normalizar
  const normalizedEvents = events.map(normalizeEvent).sort((a, b) => 
    new Date(a.date).getTime() - new Date(b.date).getTime()
  );
  
  console.log(`‚úÖ Total eventos generados: ${normalizedEvents.length}`);
  console.log('üìä Distribuci√≥n por tipo:', getEventDistribution(normalizedEvents));
  
  return normalizedEvents;
}

// ‚úÖ FUNCI√ìN MEJORADA: Generar eventos para un per√≠odo espec√≠fico
function generateEventsForPeriod(
  startDate: Date, 
  endDate: Date, 
  userProfile: UserProfile,
  period: 'past' | 'future'
): AstrologicalEvent[] {
  const events: AstrologicalEvent[] = [];
  const current = new Date(startDate);
  let eventId = period === 'past' ? 1000 : 2000;
  
  console.log(`üîÑ Generando eventos ${period}:`, {
    desde: format(startDate, 'yyyy-MM-dd'),
    hasta: format(endDate, 'yyyy-MM-dd'),
    d√≠as: differenceInDays(endDate, startDate)
  });
  
  while (current <= endDate) {
    const dayOfMonth = current.getDate();
    const dayOfWeek = current.getDay();
    const month = current.getMonth();
    
    // ‚úÖ FASES LUNARES (cada 15 d√≠as aprox)
    if (dayOfMonth === 1 || dayOfMonth === 15) {
      const isNewMoon = dayOfMonth === 1;
      events.push({
        id: `${period}-lunar-${eventId++}`,
        type: isNewMoon ? 'lunar_new' : 'lunar_full',
        date: format(current, 'yyyy-MM-dd'),
        title: `${isNewMoon ? 'Luna Nueva' : 'Luna Llena'} en ${getSignForDate(current)}`,
        description: isNewMoon ? 
          'Momento perfecto para nuevos comienzos y manifestaci√≥n' : 
          'Energ√≠a de culminaci√≥n y liberaci√≥n emocional',
        importance: 'high',
        priority: 'high', // ‚úÖ AMBOS CAMPOS
        planet: 'Luna',
        sign: getSignForDate(current)
      });
    }
    
    // ‚úÖ EVENTOS DE DESARROLLO PERSONAL (domingos espec√≠ficos)
    if (dayOfWeek === 0 && dayOfMonth % 7 === 0) {
      const isAdolescent = userProfile.currentAge < 18;
      events.push({
        id: `${period}-growth-${eventId++}`,
        type: 'life_purpose_activation',
        date: format(current, 'yyyy-MM-dd'),
        title: isAdolescent ? 
          'Momento de Autoconocimiento Adolescente' : 
          'Activaci√≥n de Prop√≥sito Personal',
        description: isAdolescent ?
          'Per√≠odo importante para entender tu identidad y relaciones' :
          'Momento de conectar con tu prop√≥sito de vida m√°s profundo',
        importance: 'medium',
        priority: 'medium', // ‚úÖ AMBOS CAMPOS
        planet: 'Sol',
        sign: userProfile.astrological?.signs?.sun || 'G√©minis'
      });
    }
    
    // ‚úÖ TR√ÅNSITOS IMPORTANTES (cada 8 d√≠as)
    if (dayOfMonth % 8 === 0) {
      const planets = ['Mercurio', 'Venus', 'Marte', 'J√∫piter'];
      const planet = planets[month % planets.length];
      
      events.push({
        id: `${period}-transit-${eventId++}`,
        type: 'planetary_transit',
        date: format(current, 'yyyy-MM-dd'),
        title: `${planet} ${period === 'past' ? 'activ√≥' : 'activar√°'} tu energ√≠a personal`,
        description: getTransitDescription(planet, userProfile, period),
        importance: planet === 'J√∫piter' ? 'high' : 'medium',
        priority: planet === 'J√∫piter' ? 'high' : 'medium', // ‚úÖ AMBOS CAMPOS
        planet,
        sign: getSignForDate(current)
      });
    }
    
    // ‚úÖ RETROGRADACIONES (menos frecuentes pero importantes)
    if (dayOfMonth % 25 === 0 && Math.random() > 0.7) {
      events.push({
        id: `${period}-retro-${eventId++}`,
        type: 'retrograde',
        date: format(current, 'yyyy-MM-dd'),
        title: 'Per√≠odo de Revisi√≥n Planetaria',
        description: 'Momento excelente para revisar, reflexionar y reorganizar',
        importance: 'high',
        priority: 'high', // ‚úÖ AMBOS CAMPOS
        planet: 'Mercurio'
      });
    }
    
    current.setDate(current.getDate() + 1);
  }
  
  return events;
}

// ‚úÖ FUNCI√ìN NUEVA: Eventos especiales para el a√±o astrol√≥gico
function generateSpecialEvents(
  lastBirthday: Date,
  nextBirthday: Date,
  userProfile: UserProfile
): AstrologicalEvent[] {
  const events: AstrologicalEvent[] = [];
  let eventId = 3000;
  
  // Evento especial en el cumplea√±os
  events.push({
    id: `birthday-${eventId++}`,
    type: 'solar_activation',
    date: format(lastBirthday, 'yyyy-MM-dd'),
    title: `¬°Feliz Cumplea√±os ${userProfile.currentAge}!`,
    description: 'Tu Revoluci√≥n Solar: inicio de un nuevo ciclo de crecimiento y oportunidades',
    importance: 'high',
    priority: 'high',
    planet: 'Sol',
    sign: userProfile.astrological?.signs?.sun || 'G√©minis'
  });
  
  // Eventos de mitad de a√±o (6 meses despu√©s del cumplea√±os)
  const halfYear = new Date(lastBirthday);
  halfYear.setMonth(halfYear.getMonth() + 6);
  
  if (halfYear <= nextBirthday) {
    events.push({
      id: `half-year-${eventId++}`,
      type: 'solar_activation',
      date: format(halfYear, 'yyyy-MM-dd'),
      title: 'Punto Medio del A√±o Astrol√≥gico',
      description: 'Momento de evaluaci√≥n y reajuste de metas del a√±o',
      importance: 'high',
      priority: 'high',
      planet: 'Sol',
      sign: getOppositeSign(userProfile.astrological?.signs?.sun || 'G√©minis')
    });
  }
  
  // Eventos de cuartos del a√±o astrol√≥gico
  const quarterPoints = [3, 9]; // 3 y 9 meses despu√©s del cumplea√±os
  
  quarterPoints.forEach(monthsAfter => {
    const quarterDate = new Date(lastBirthday);
    quarterDate.setMonth(quarterDate.getMonth() + monthsAfter);
    
    if (quarterDate <= nextBirthday) {
      events.push({
        id: `quarter-${monthsAfter}-${eventId++}`,
        type: 'seasonal',
        date: format(quarterDate, 'yyyy-MM-dd'),
        title: `${monthsAfter === 3 ? 'Primer' : 'Tercer'} Cuarto del A√±o Astrol√≥gico`,
        description: `Momento de ${monthsAfter === 3 ? 'acci√≥n decidida' : 'liberaci√≥n y preparaci√≥n'}`,
        importance: 'medium',
        priority: 'medium',
        planet: monthsAfter === 3 ? 'Marte' : 'Saturno',
        sign: getSignForDate(quarterDate)
      });
    }
  });
  
  return events;
}

// ‚úÖ FUNCIONES AUXILIARES MEJORADAS

function getSignForDate(date: Date): string {
  const month = date.getMonth();
  const day = date.getDate();
  
  // C√°lculo simplificado por mes (en producci√≥n usar Swiss Ephemeris)
  const signsByMonth = [
    'Capricornio', 'Acuario', 'Piscis', 'Aries', 'Tauro', 'G√©minis',
    'C√°ncer', 'Leo', 'Virgo', 'Libra', 'Escorpio', 'Sagitario'
  ];
  
  // Ajuste aproximado por d√≠a del mes
  if (day <= 20) {
    return signsByMonth[month] || 'Aries';
  } else {
    return signsByMonth[(month + 1) % 12] || 'Aries';
  }
}

function getOppositeSign(sign: string): string {
  const opposites: Record<string, string> = {
    'Aries': 'Libra', 'Libra': 'Aries',
    'Tauro': 'Escorpio', 'Escorpio': 'Tauro',
    'G√©minis': 'Sagitario', 'Sagitario': 'G√©minis',
    'C√°ncer': 'Capricornio', 'Capricornio': 'C√°ncer',
    'Leo': 'Acuario', 'Acuario': 'Leo',
    'Virgo': 'Piscis', 'Piscis': 'Virgo'
  };
  return opposites[sign] || sign;
}

function getTransitDescription(
  planet: string, 
  userProfile: UserProfile, 
  period: 'past' | 'future'
): string {
  const age = userProfile.currentAge;
  const verb = period === 'past' ? 'activ√≥' : 'activar√°';
  
  if (age < 18) {
    switch (planet) {
      case 'Mercurio': 
        return `${verb} tu mente: excelente momento para estudios y comunicaci√≥n con amigos`;
      case 'Venus': 
        return `${verb} tu creatividad: per√≠odo favorable para arte y armon√≠a en relaciones`;
      case 'Marte': 
        return `${verb} tu energ√≠a: impulso extra para deportes y actividades que te apasionan`;
      case 'J√∫piter':
        return `${verb} tu expansi√≥n: oportunidades de crecimiento personal y nuevas experiencias`;
      default: 
        return `${verb} tu crecimiento personal de manera importante`;
    }
  } else {
    switch (planet) {
      case 'Mercurio': 
        return `${verb} tu comunicaci√≥n: per√≠odo excelente para decisiones profesionales importantes`;
      case 'Venus': 
        return `${verb} tu magnetismo: momento favorable para relaciones y asuntos financieros`;
      case 'Marte': 
        return `${verb} tu poder de acci√≥n: energ√≠a potente para iniciar proyectos importantes`;
      case 'J√∫piter':
        return `${verb} tu suerte: momento de expansi√≥n y oportunidades √∫nicas`;
      default: 
        return `${verb} aspectos importantes de tu vida personal y profesional`;
    }
  }
}

function getEventDistribution(events: AstrologicalEvent[]): Record<string, number> {
  const distribution: Record<string, number> = {};
  
  events.forEach(event => {
    distribution[event.type] = (distribution[event.type] || 0) + 1;
  });
  
  return distribution;
}

// ‚úÖ FUNCIONES AUXILIARES PARA EVENTOS ESPECIALES

function getRandomEventType(): EventType {
  const types: EventType[] = [
    'venus_harmony', 'mars_action', 'mercury_communication',
    'solar_activation', 'lunar_resonance', 'life_purpose_activation'
  ];
  return types[Math.floor(Math.random() * types.length)];
}

function generateEventTitle(userProfile: UserProfile): string {
  const age = userProfile.currentAge;
  const titles = age < 18 ? [
    'Momento de Creatividad Adolescente',
    'Energ√≠a para Nuevas Amistades',
    'Per√≠odo de Autoconocimiento',
    'Activaci√≥n de Talentos Naturales',
    'Momento de Expresi√≥n Personal'
  ] : [
    'Activaci√≥n de Poder Personal',
    'Momento de Claridad Profesional',
    'Energ√≠a para Nuevos Proyectos',
    'Per√≠odo de Manifestaci√≥n',
    'Oportunidad de Transformaci√≥n'
  ];
  
  return titles[Math.floor(Math.random() * titles.length)];
}

function generateEventDescription(userProfile: UserProfile): string {
  const age = userProfile.currentAge;
  const descriptions = age < 18 ? [
    'Momento perfecto para explorar nuevos intereses y conectar con tu verdadero yo',
    'Per√≠odo excelente para fortalecer amistades y desarrollar habilidades sociales',
    'Energ√≠a favorable para estudios y actividades creativas',
    'Tiempo ideal para expresar tu personalidad √∫nica y aut√©ntica'
  ] : [
    'Per√≠odo favorable para decisiones importantes sobre carrera y relaciones',
    'Momento excelente para manifestar proyectos y objetivos a largo plazo',
    'Energ√≠a potente para transformar aspectos clave de tu vida',
    'Oportunidad √∫nica para conectar con tu prop√≥sito m√°s profundo'
  ];
  
  return descriptions[Math.floor(Math.random() * descriptions.length)];
}

function getRandomPlanet(): string {
  const planets = ['Sol', 'Luna', 'Mercurio', 'Venus', 'Marte', 'J√∫piter'];
  return planets[Math.floor(Math.random() * planets.length)];
}

// ‚úÖ FUNCI√ìN PARA VERIFICAR QUE LOS EVENTOS CUBRAN TODO EL PER√çODO
export function validateEventCoverage(
  events: AstrologicalEvent[],
  expectedStartDate: string,
  expectedEndDate: string
): {
  isComplete: boolean;
  missingPeriods: string[];
  coverage: {
    totalEvents: number;
    pastEvents: number;
    futureEvents: number;
    coveragePercentage: number;
  };
} {
  const start = new Date(expectedStartDate);
  const end = new Date(expectedEndDate);
  const today = new Date();
  
  const pastEvents = events.filter(event => new Date(event.date) < today).length;
  const futureEvents = events.filter(event => new Date(event.date) >= today).length;
  
  const totalDays = differenceInDays(end, start);
  const daysWithEvents = new Set(events.map(event => event.date)).size;
  const coveragePercentage = Math.round((daysWithEvents / totalDays) * 100);
  
  console.log('üìä Validaci√≥n de cobertura:', {
    per√≠odo: `${expectedStartDate} ‚Üí ${expectedEndDate}`,
    totalEventos: events.length,
    eventosDelPasado: pastEvents,
    eventosDelFuturo: futureEvents,
    d√≠asConEventos: daysWithEvents,
    d√≠asTotales: totalDays,
    cobertura: `${coveragePercentage}%`
  });
  
  return {
    isComplete: coveragePercentage >= 40, // M√≠nimo 40% de d√≠as con eventos
    missingPeriods: coveragePercentage < 40 ? ['Cobertura insuficiente'] : [],
    coverage: {
      totalEvents: events.length,
      pastEvents,
      futureEvents,
      coveragePercentage
    }
  };
}

export default {
  generateCompleteEventCalendar,
  validateEventCoverage
};