// scripts/clear-cache.js
// ğŸ—‘ï¸ SCRIPT PARA LIMPIAR CACHÃ‰ DE MONGODB

require('dotenv').config();
const mongoose = require('mongoose');

async function clearCache() {
  try {
    console.log('ğŸ”— Conectando a MongoDB...');
    await mongoose.connect(process.env.MONGODB_URI);
    console.log('âœ… Conectado exitosamente');

    // ğŸ“Š ESTADÃSTICAS ANTES DE LIMPIAR
    const collections = ['user_agenda_cache', 'charts', 'cache'];
    const statsBefore = {};

    for (const collectionName of collections) {
      try {
        const count = await mongoose.connection.collection(collectionName).countDocuments();
        statsBefore[collectionName] = count;
        console.log(`ğŸ“Š ${collectionName}: ${count} documentos`);
      } catch (error) {
        console.log(`âš ï¸ ColecciÃ³n ${collectionName} no existe o estÃ¡ vacÃ­a`);
        statsBefore[collectionName] = 0;
      }
    }

    // ğŸ—‘ï¸ LIMPIAR CACHÃ‰ DE APLICACIÃ“N
    console.log('\nğŸ—‘ï¸ Limpiando cachÃ©...');

    let totalDeleted = 0;
    for (const collectionName of collections) {
      try {
        const result = await mongoose.connection.collection(collectionName).deleteMany({});
        console.log(`âœ… ${collectionName}: eliminados ${result.deletedCount} documentos`);
        totalDeleted += result.deletedCount;
      } catch (error) {
        console.log(`âš ï¸ Error limpiando ${collectionName}: ${error.message}`);
      }
    }

    // ğŸ“Š ESTADÃSTICAS DESPUÃ‰S
    console.log('\nğŸ“Š VerificaciÃ³n despuÃ©s de limpiar:');
    for (const collectionName of collections) {
      try {
        const count = await mongoose.connection.collection(collectionName).countDocuments();
        console.log(`ğŸ“Š ${collectionName}: ${count} documentos restantes`);
      } catch (error) {
        console.log(`âš ï¸ ColecciÃ³n ${collectionName} no accesible`);
      }
    }

    // ğŸ”Œ CERRAR CONEXIÃ“N
    await mongoose.connection.close();
    console.log('âœ… ConexiÃ³n cerrada');

    console.log(`\nğŸ‰ Â¡CachÃ© limpiado exitosamente! Total eliminados: ${totalDeleted} documentos`);

  } catch (error) {
    console.error('âŒ Error en clearCache:', error);
    process.exit(1);
  }
}

// ğŸš€ EJECUTAR SI SE LLAMA DIRECTAMENTE
if (require.main === module) {
  clearCache();
}

module.exports = { clearCache };
